<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="format-detection" content="telephone=no">
    <title>FP3級 問題集</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- ダークモードボタン -->
        <button id="dark-mode-btn" class="dark-mode-btn" onclick="toggleDarkMode()" title="ダークモード">
            &#127769;
        </button>

        <!-- スタート画面 -->
        <div id="start-screen" class="screen active">
            <div class="header">
                <h1>FP3級（ファイナンシャル・プランニング技能検定）</h1>
                <h2>過去問題集</h2>
                <p class="year">3級学科試験対策</p>
            </div>

            <!-- 試験日カウントダウン -->
            <div id="exam-countdown" class="exam-countdown">
                <div class="countdown-header">
                    <span class="countdown-icon">&#128197;</span>
                    <span class="countdown-title">試験日まであと</span>
                </div>
                <div class="countdown-body">
                    <span id="countdown-days" class="countdown-days">--</span>
                    <span class="countdown-unit">日</span>
                </div>
                <div class="countdown-date" id="countdown-date">試験日未設定</div>
                <button class="countdown-btn" onclick="setExamDate()">試験日を設定</button>
            </div>

            <!-- 学習状況サマリー -->
            <div class="stats-summary">
                <div class="stats-item">
                    <span class="stats-label">累計正答率</span>
                    <span id="overall-rate" class="stats-value">--%</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">学習回数</span>
                    <span id="total-attempts" class="stats-value">0回</span>
                </div>
                <div class="stats-item clickable" onclick="showStatsScreen()">
                    <span class="stats-label">詳細を見る</span>
                    <span class="stats-value">&#128202;</span>
                </div>
            </div>

            <div class="exam-info">
                <div class="info-card">
                    <h3>試験概要</h3>
                    <ul>
                        <li><strong>出題範囲:</strong> ライフプランニング・リスク管理・金融資産運用・タックスプランニング・不動産・相続</li>
                        <li><strong>出題形式:</strong> 四肢択一式（○×・三択を四択形式に変換）</li>
                        <li><strong>学習方法:</strong> 問題を見て解答を考え、選択肢をタップ</li>
                    </ul>
                </div>
            </div>

            <!-- 弱点分析セクション -->
            <div class="weakness-analysis">
                <h3>弱点分析</h3>
                <div id="category-stats" class="category-stats">
                    <!-- 動的に生成 -->
                </div>
                <button id="weak-area-study-btn" class="btn btn-danger" onclick="startWeakAreaStudy()" style="margin-top: 16px;">
                    <span class="btn-icon">&#128293;</span>
                    苦手分野を集中学習
                </button>
            </div>

            <!-- 復習セクション -->
            <div class="review-section">
                <h3>復習学習</h3>
                <div class="review-buttons">
                    <button id="review-wrong-btn" class="btn btn-warning" onclick="startWrongReview()">
                        <span class="btn-icon">&#128260;</span>
                        <span class="btn-text">
                            間違えた問題
                            <span class="btn-badge" id="wrong-count">0問</span>
                        </span>
                    </button>
                    <button id="study-bookmark-btn" class="btn btn-info" onclick="startBookmarkStudy()">
                        <span class="btn-icon">&#11088;</span>
                        <span class="btn-text">
                            ブックマーク
                            <span class="btn-badge" id="bookmark-count">0問</span>
                        </span>
                    </button>
                </div>
            </div>

            <div class="session-filter">
                <h3>年度を選択</h3>
                <div id="year-buttons" class="session-buttons">
                    <!-- 動的に生成 -->
                </div>
            </div>

            <div class="session-filter">
                <h3>分野を選択</h3>
                <div id="session-buttons" class="session-buttons">
                    <!-- 動的に生成 -->
                </div>
            </div>

            <div class="mode-selection">
                <h3>学習モードを選択</h3>
                <button class="btn btn-primary" onclick="startQuiz('all')">
                    <span class="btn-icon">&#128221;</span>
                    全問題
                </button>
                <button class="btn btn-accent" onclick="startQuiz('random')">
                    <span class="btn-icon">&#127922;</span>
                    ランダム20問
                </button>
            </div>

            <!-- タイマーモード -->
            <div class="timer-mode-section">
                <h3>本番形式（タイマー付き）</h3>
                <p class="timer-description">制限時間内に解答する本番形式の練習ができます</p>
                <div class="timer-buttons">
                    <button class="btn btn-timer" onclick="startTimerMode('all')">
                        <span class="btn-icon">&#9201;</span>
                        全問題
                    </button>
                    <button class="btn btn-timer" onclick="startTimerMode('random')">
                        <span class="btn-icon">&#9201;</span>
                        ランダム
                    </button>
                </div>
            </div>

            <!-- 印刷用問題集 -->
            <div class="print-section">
                <h3>印刷用問題集</h3>
                <p class="print-description">問題と選択肢を印刷用にレイアウトして出力します</p>
                <button class="btn btn-print" onclick="generatePrintableQuiz()">
                    <span class="btn-icon">&#128438;</span>
                    印刷用PDF
                </button>
            </div>

            <div class="back-link" style="text-align: center; margin-top: 20px;">
                <a href="../index.html" style="color: var(--primary-color); text-decoration: none;">&#8592; トップページに戻る</a>
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quiz-screen" class="screen">
            <div class="quiz-header">
                <div class="quiz-header-top">
                    <button class="home-btn" onclick="goHome()" title="トップに戻る">&#10005;</button>
                    <div id="timer-display" class="timer-display hidden">
                        <span class="timer-icon">&#9201;</span>
                        <span id="timer-text">00:00</span>
                    </div>
                    <div class="session-badge" id="session-badge">問題</div>
                    <button id="bookmark-btn" class="bookmark-btn" onclick="bookmarkCurrentQuestion()" title="ブックマークに追加">
                        &#9734;
                    </button>
                </div>
                <div class="progress-info">
                    <span id="current-num">1</span> / <span id="total-num">50</span>
                </div>
                <div class="progress-bar">
                    <div id="progress" class="progress-fill"></div>
                </div>
                <div class="score-info">
                    正解: <span id="correct-count">0</span>問
                </div>
            </div>

            <div class="question-card">
                <div class="question-number">
                    問 <span id="question-no">1</span>
                </div>
                <div id="question-text" class="question-text"></div>
                <div id="choices" class="choices"></div>
            </div>

            <div id="result-feedback" class="feedback hidden">
                <div id="feedback-icon" class="feedback-icon"></div>
                <div id="feedback-text" class="feedback-text"></div>
                <div id="correct-answer" class="correct-answer"></div>
                <div id="explanation" class="explanation hidden"></div>
            </div>

            <div id="answer-section" class="answer-section hidden">
                <div class="answer-header">&#128161; 解答・解説</div>
                <div id="answer-text" class="answer-text"></div>
            </div>

            <div class="quiz-controls">
                <button id="show-answer-btn" class="btn btn-primary hidden" onclick="showAnswer()">
                    <span class="btn-icon">&#128065;</span>解答を表示
                </button>
                <div id="flashcard-controls" class="flashcard-controls hidden">
                    <button class="btn btn-secondary" onclick="markWrong()">
                        <span class="btn-icon">&#128534;</span>難しい
                    </button>
                    <button class="btn btn-success" onclick="markCorrect()">
                        <span class="btn-icon">&#128077;</span>わかった
                    </button>
                </div>
                <button id="next-btn" class="btn btn-primary hidden" onclick="nextQuestion()">
                    次の問題へ &#8594;
                </button>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="result-screen" class="screen">
            <div class="result-header">
                <h2>試験結果</h2>
            </div>
            <div class="result-card">
                <div class="score-circle">
                    <span id="final-score">0</span>
                    <span class="score-label">点</span>
                </div>
                <div class="result-details">
                    <p>正解数: <span id="result-correct">0</span> / <span id="result-total">50</span></p>
                    <p>正答率: <span id="result-rate">0</span>%</p>
                    <p class="wrong-count-result">間違い: <span id="wrong-in-session">0</span>問</p>
                </div>
                <!-- 合格ライン比較 -->
                <div id="pass-line-comparison" class="pass-line-comparison"></div>
                <div id="result-message" class="result-message"></div>
            </div>
            <!-- 苦手分野分析 -->
            <div class="result-analysis-section">
                <h3>分野別正答率</h3>
                <div id="result-weak-analysis" class="result-weak-analysis"></div>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" onclick="reviewAnswers()">
                    <span class="btn-icon">&#128203;</span>
                    解答を確認
                </button>
                <button class="btn btn-warning" onclick="startWrongReview()">
                    <span class="btn-icon">&#128260;</span>
                    間違えた問題を復習
                </button>
                <button class="btn btn-secondary" onclick="restartQuiz()">
                    <span class="btn-icon">&#128257;</span>
                    もう一度挑戦
                </button>
                <button class="btn btn-accent" onclick="goHome()">
                    <span class="btn-icon">&#127968;</span>
                    スタートに戻る
                </button>
                <a href="../index.html" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                    <span class="btn-icon">&#127760;</span>
                    サイトトップへ
                </a>
            </div>
        </div>

        <!-- 解答確認画面 -->
        <div id="review-screen" class="screen">
            <div class="review-header">
                <h2>解答一覧</h2>
                <button class="btn btn-small" onclick="goToResult()">&#8592; 結果に戻る</button>
            </div>
            <div class="review-filter">
                <button class="filter-btn active" onclick="filterReview('all')">全て</button>
                <button class="filter-btn" onclick="filterReview('wrong')">不正解のみ</button>
                <button class="filter-btn" onclick="filterReview('correct')">正解のみ</button>
            </div>
            <div id="review-list" class="review-list"></div>
        </div>

        <!-- 統計画面 -->
        <div id="stats-screen" class="screen">
            <div class="stats-header">
                <h2>学習統計</h2>
                <button class="btn btn-small" onclick="goHome()">&#8592; 戻る</button>
            </div>

            <div class="stats-cards">
                <div class="stats-card">
                    <h3>全体統計</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">学習回数</span>
                            <span id="stats-total-attempts" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">解答問題数</span>
                            <span id="stats-total-questions" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">正解数</span>
                            <span id="stats-total-correct" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">累計正答率</span>
                            <span id="stats-overall-rate" class="stat-value">0%</span>
                        </div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>分野別正答率</h3>
                    <div id="stats-category-analysis" class="category-stats"></div>
                    <button id="stats-weak-area-btn" class="btn btn-danger" onclick="startWeakAreaStudy()" style="margin-top: 16px;">
                        <span class="btn-icon">&#128293;</span>
                        苦手分野を集中学習
                    </button>
                </div>

                <div class="stats-card">
                    <h3>苦手な問題 TOP10</h3>
                    <div id="weak-questions-list" class="weak-list"></div>
                </div>

                <div class="stats-card">
                    <h3>学習履歴（直近10回）</h3>
                    <div id="history-list" class="history-list"></div>
                </div>

                <div class="stats-card danger-zone">
                    <h3>データ管理</h3>
                    <p class="danger-text">学習データをリセットすると、間違い記録・統計・ブックマークが全て削除されます。</p>
                    <button class="btn btn-danger" onclick="resetAllData()">
                        <span class="btn-icon">&#128465;</span>
                        データをリセット
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../supabase-service.js"></script>
    <script src="../auth-ui.js"></script>
    <script src="../user-manager.js"></script>
    <script src="questions.js"></script>
    <script src="app.js"></script>
</body>
</html>
